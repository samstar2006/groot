# fastlane/Fastfile

platform :ios do
  desc "Upload IPA to TestFlight"
  
  lane :upload_ipa_to_testflight do |options|
    # Generate an App Store Connect API key for authentication
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],               # Your API key ID
      issuer_id: ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID'],     # Your API key issuer ID
      key_content: ENV['APP_STORE_CONNECT_API_KEY']              # Your API key content
    )

    # Ensure versioning is set correctly by incrementing the version number
    increment_version_number(
      bump_type: "patch",                # This will increment the version number (e.g., from 1.0 to 1.0.1)
      xcodeproj: "I am Groot.xcodeproj"  # Specify your Xcode project if it's not in the default location
    )

    # Increment the build number based on the latest TestFlight build number
    increment_build_number(
      build_number: latest_testflight_build_number(api_key: api_key) + 1
    )

    # Build the app using the specified workspace and scheme
    build_app(
      workspace: "I am Groot.xcodeproj", # Specify your Xcode project
      scheme: "I am Groot"               # Specify the scheme to use for building the app
    )

    # Upload the built IPA file to TestFlight
    upload_to_testflight(
      ipa: options[:ipa],                 # Path to the IPA file to be uploaded
      api_key: api_key,                   # Use the previously generated API key for authentication
      app_identifier: "com.pizza.man"     # Ensure this matches exactly with your app identifier
    )
  end
end


